(()=>{"use strict";async function e(){return await chrome.tabs.query({active:!0,lastFocusedWindow:!0})}function t(e){return/[a-zA-Z]/.test(e)}let a=[];function o(){fetch("https://crepsource.pythonanywhere.com/get/").then((e=>e.json())).then((e=>{a=e,e&&chrome.storage.local.set({sites:a})})).catch((e=>{throw e}))}chrome.runtime.onInstalled.addListener((()=>{chrome.storage.local.set({codeSize:80}),chrome.contextMenus.create({id:"withoutDeal",contexts:["image"],title:"Without Deal",type:"normal"}),chrome.contextMenus.create({id:"Restock",contexts:["image"],title:"Restock",type:"radio",parentId:"withoutDeal"}),chrome.contextMenus.create({id:"New",contexts:["image"],title:"New",type:"radio",parentId:"withoutDeal"}),chrome.contextMenus.create({id:"Selling Fast",contexts:["image"],title:"Selling Fast",type:"radio",parentId:"withoutDeal"}),chrome.contextMenus.create({id:"Last Sizes",contexts:["image"],title:"Last Sizes",type:"radio",parentId:"withoutDeal"}),chrome.contextMenus.create({id:"seperator1",contexts:["image"],title:"seperator1",type:"separator"}),chrome.contextMenus.create({id:"withDeal",contexts:["image"],title:"With deal",type:"normal"}),chrome.contextMenus.create({id:"dealWithoutCode",contexts:["image"],title:"with no code",type:"normal",parentId:"withDeal"}),chrome.contextMenus.create({id:"dealWithCode",contexts:["image"],title:"With code",type:"normal",parentId:"withDeal"}),chrome.contextMenus.create({id:"dealWithCodeAndComment",contexts:["image"],title:"with code and comment",type:"normal",parentId:"withDeal"}),chrome.contextMenus.create({id:"reel",contexts:["image"],title:"Tiktok_Reel",type:"normal",parentId:"withDeal"})})),o(),setInterval(o,18e5),chrome.contextMenus.onClicked.addListener((async(a,o)=>{let n=a.menuItemId;console.log(a);let i="",r="index.html",[c]=await e();if(!c||!c.id)return;let s=await chrome.tabs.sendMessage(c.id,{type:"sendActive"});if(!s)return;let l=s.target,d=s.info.price,h=s.info.sizes;console.log(h);let m=s.info.dontSort,p=t(h[0])?h[0].toUpperCase():m?h[0]:Math.min(...h).toString(),u=t(h[0])?h.at(-1).toUpperCase():m?h.slice(-1)[0]:Math.max(...h).toString(),g=s.info.title,x=s.info.style,w=s.info.gender,y=s.info.RRP||d,f=s.host;switch(w&&(w=w.toLowerCase(),w.includes("kids")?w="Juniors":w.includes("unisex")&&(w="")),n){case"Restock":i="Restock";break;case"New":i="New";break;case"Selling Fast":r="deals.html",i="Selling Fast";break;case"dealWithoutCode":case"dealWithCode":case"dealWithCodeAndComment":r="deals.html",i=w||"";break;case"reel":r="reel.html",i=w||"";break;default:i=n}chrome.tabs.create({url:chrome.runtime.getURL(r),active:!1,pinned:!0},(e=>{let t=(a,o)=>{a==e.id&&"complete"==o.status&&(chrome.tabs.sendMessage(a,{type:"run",imageSrc:l,title:g,price:d.replace(",",""),minSize:p,maxSize:u,style:x,banner:i,gender:w,RRP:y.replace(",",""),itemId:n,host:f}),chrome.tabs.onUpdated.removeListener(t))};chrome.tabs.onUpdated.addListener(t)}))})),chrome.runtime.onMessage.addListener(((t,a,o)=>{switch(t.type){case"closeMe":if(!a?.tab?.id)return;chrome.tabs.remove(a.tab.id);break;case"scrape":e().then((([e])=>{var t;t=e.id,chrome.scripting.executeScript({target:{tabId:t},files:["scrape.js"]})}));break;case"sendToSheet":!async function(e){const t=e.data,{deploymentUrl:a,discountPercentage:o,discountCode:n}=await chrome.storage.local.get();if(n&&""==t.code){t.code=n;const e=t["Sale Price"].replace("£","");if(o){const a="£"+parseInt(+e*(100-o)/100);t["Sale Price"]=a}}if(!a)return console.log("no deployment url to send data");const i=a+"?type=append";await fetch(i,{method:"POST",body:JSON.stringify({data:t})}).catch((e=>console.log("Err in bg fetch ",e)))}(t)}return!0}))})();